<script>
  const ENDPOINT = "https://script.google.com/macros/s/AKfycbyh4B80uphw60w9GarZSsxfg3zdS0H8dp-QM9MolZhF6wjLsxGR25eHLuyj40JlV42pLw/exec";

  const form = document.getElementById("qForm");
  const statusBox = document.getElementById("statusBox");

  function setStatus(type, msg){
    statusBox.className = "status " + type;
    statusBox.textContent = msg;
    statusBox.scrollIntoView({ behavior: "smooth", block: "nearest" });
  }

  function isValidEmail(v){
    const s = (v || "").trim();
    return s.includes("@") && s.includes(".");
  }

  // Country filter: type-to-filter the dropdown
  (function initCountryFilter(){
    const search = document.getElementById("countrySearch");
    const select = document.getElementById("country");
    if(!search || !select) return;

    const allOptions = Array.from(select.options).map(o => ({ value:o.value, text:o.text, disabled:o.disabled }));

    function applyFilter(){
      const q = (search.value || "").trim().toLowerCase();
      select.innerHTML = "";
      allOptions.forEach(opt => {
        if(opt.disabled){
          const o = document.createElement("option");
          o.value = opt.value;
          o.textContent = opt.text;
          o.disabled = true;
          if(opt.value === "") o.selected = true;
          select.appendChild(o);
          return;
        }

        if(!q || opt.text.toLowerCase().includes(q)){
          const o = document.createElement("option");
          o.value = opt.text;
          o.textContent = opt.text;
          select.appendChild(o);
        }
      });

      const opts = Array.from(select.options).filter(o => !o.disabled && o.value);
      if(q && opts.length === 1){
        select.value = opts[0].value;
      }
    }

    search.addEventListener("input", applyFilter);
  })();

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    if(!ENDPOINT || !ENDPOINT.startsWith("https://script.google.com/macros/s/")){
      return setStatus("error", "Setup incomplete: endpoint not set.");
    }

    const data = Object.fromEntries(new FormData(form).entries());

    const consentResearch = !!document.getElementById("consentResearch").checked;
    if(!consentResearch){
      return setStatus("error", "Please confirm the required consent checkbox to submit.");
    }

    const wantsContact = !!document.getElementById("consentContact").checked;
    const wantsUpdates = !!document.getElementById("consentUpdates").checked;

    const email = (data.email || "").trim().toLowerCase();
    if((wantsContact || wantsUpdates) && !isValidEmail(email)){
      return setStatus("error", "Please enter a valid email address if you consent to follow-up or updates.");
    }

    const country = (data.country || "").trim();
    if(!country){
      return setStatus("error", "Please select a country / jurisdiction.");
    }

    const payload = {
      ...data,
      email,
      country,
      lang: "en",
      page: "clinicians-questionnaire",
      source: "web-questionnaire",
      consentResearch,
      consentContact: wantsContact,
      consentUpdates: wantsUpdates,
      timestampISO: new Date().toISOString(),
      referrer: document.referrer || "",
      userAgent: navigator.userAgent || ""
    };

    try {
      const res = await fetch(ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload)
      });

      const json = await res.json().catch(() => null);

      if(json && json.ok){
        setStatus("success",
          "Thank you. Your response has been submitted. If you requested updates, you will receive emails and can unsubscribe any time."
        );
        form.reset();
      } else {
        setStatus("error", (json && json.message) ? json.message : "Something went wrong. Please try again, or email contact@simhealth.pro.");
      }

    } catch (err) {
      console.error(err);
      setStatus("error", "Something went wrong. Please try again, or email contact@simhealth.pro.");
    }
  });
</script>
